<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Manajemen Keuangan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Efek Glow pada Card dan Tabel */
        .card-glow, .table-glow {
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.1); /* Biru lembut */
            border-radius: 0.5rem;
        }
        .card-glow:hover {
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3), 0 0 10px rgba(0, 123, 255, 0.2);
            transform: translateY(-2px);
        }

        .table-glow th, .table-glow td {
            border-color: rgba(0, 123, 255, 0.1);
        }
        .table-glow tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05); /* Efek hover baris tabel */
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.1);
        }

        /* Efek Hover pada Tombol */
        .btn-hover-scale {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-hover-scale:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }

        /* Glow Tombol Khusus */
        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(13, 110, 253, 0.6);
        }
        .btn-success:hover {
            box-shadow: 0 0 15px rgba(25, 135, 84, 0.6);
        }
        .btn-danger:hover {
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.6);
        }

        /* Posisi Toast/Notifikasi */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1080; /* Pastikan di atas semua elemen Bootstrap, termasuk modal */
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">üí∞ Manajemen Keuangan Lo</a>
            <button id="resetDataBtn" class="btn btn-sm btn-danger btn-hover-scale" type="button">
                <i class="bi bi-trash"></i> Reset Data
            </button>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row g-4">
            
            <div class="col-lg-5 order-lg-1">
                <div class="row g-4">
                    
                    <div class="col-12">
                        <div class="card text-white bg-primary card-glow">
                            <div class="card-header fw-bold">üí∏ Rekap Cepat</div>
                            <div class="card-body">
                                <h5 class="card-title">Total Saldo Lo Sekarang:</h5>
                                <p class="card-text fs-2 fw-bolder" id="totalSaldoDisplay">Rp0</p>
                                <hr>
                                <h5 class="card-title">Rata-rata Keluar Harian:</h5>
                                <p class="card-text fs-4" id="avgDailyExpenseDisplay">Rp0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-danger text-white fw-bold">üî• Quick Review Pengeluaran</div>
                            <div class="card-body">
                                <div class="row text-center g-2">
                                    <div class="col-4">
                                        <div class="p-2 border rounded bg-light">
                                            <small class="text-muted">Kemarin</small>
                                            <p class="mb-0 fw-bold text-danger" id="reviewKemarin">Rp0</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 border rounded bg-light">
                                            <small class="text-muted">Hari Ini</small>
                                            <p class="mb-0 fw-bold text-danger" id="reviewHariIni">Rp0</p>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="p-2 border rounded bg-light">
                                            <small class="text-muted">Minggu Ini</small>
                                            <p class="mb-0 fw-bold text-danger" id="reviewMingguIni">Rp0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-warning text-dark fw-bold">‚öñÔ∏è Cek Balance (Uang Nyata)</div>
                            <div class="card-body">
                                <form id="cekBalanceForm">
                                    <div class="mb-3">
                                        <label for="uangNyata" class="form-label">Uang Nyata Gue Sekarang (Rp)</label>
                                        <input type="number" class="form-control" id="uangNyata" required placeholder="Contoh: 500000">
                                    </div>
                                    <button type="submit" class="btn btn-warning w-100 btn-hover-scale">Cek Selisih</button>
                                </form>
                                <div id="balanceResult" class="mt-3 p-3 text-center rounded border border-secondary" style="display: none;">
                                    <p class="mb-1">Saldo Sistem: <strong id="saldoSistemDisplay">Rp0</strong></p>
                                    <p class="mb-1">Uang Nyata: <strong id="uangNyataDisplay">Rp0</strong></p>
                                    <hr>
                                    <p class="fs-5 mb-0" id="selisihResultText">Hasil Cek:</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-success text-white fw-bold">üçö Dana Uang Makan</div>
                            <div class="card-body">
                                <form id="addUangMakanForm" class="mb-3">
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="addUangMakan" placeholder="Tambah Dana (Rp)" required>
                                        <button class="btn btn-outline-success btn-hover-scale" type="submit">Tambah</button>
                                    </div>
                                </form>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm table-glow">
                                        <thead class="table-success">
                                            <tr>
                                                <th>Total Dana</th>
                                                <th>Terpakai</th>
                                                <th>Sisa</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="fw-bold">
                                                <td id="totalDanaMakan">Rp0</td>
                                                <td id="terpakaiMakan">Rp0</td>
                                                <td id="sisaDanaMakan">Rp0</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-success text-white fw-bold">‚ûï Riwayat Uang Masuk</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm table-glow mb-0">
                                        <thead class="table-success">
                                            <tr>
                                                <th>Nominal</th>
                                                <th>Waktu</th>
                                            </tr>
                                        </thead>
                                        <tbody id="riwayatMasukBody">
                                            <tr><td colspan="2" class="text-center">Belum ada uang masuk.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-lg-7 order-lg-2">
                <div class="row g-4">
                    
                    <div class="col-md-6">
                        <div class="card card-glow">
                            <div class="card-header bg-success text-white fw-bold">‚ûï Input Uang Masuk</div>
                            <div class="card-body">
                                <form id="uangMasukForm">
                                    <div class="mb-3">
                                        <label for="nominalMasuk" class="form-label">Nominal (Rp)</label>
                                        <input type="number" class="form-control" id="nominalMasuk" required placeholder="Contoh: 1000000">
                                    </div>
                                    <button type="submit" class="btn btn-success w-100 btn-hover-scale">Simpan Uang Masuk</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card card-glow">
                            <div class="card-header bg-danger text-white fw-bold">‚ûñ Input Uang Keluar</div>
                            <div class="card-body">
                                <form id="uangKeluarForm">
                                    <div class="mb-3">
                                        <label for="nominalKeluar" class="form-label">Nominal (Rp)</label>
                                        <input type="number" class="form-control" id="nominalKeluar" required placeholder="Contoh: 50000">
                                    </div>
                                    <div class="mb-3">
                                        <label for="keteranganKeluar" class="form-label">Kategori</label>
                                        <select class="form-select" id="keteranganKeluar" required>
                                            <option value="">Pilih Kategori</option>
                                            <option value="makan">Makan üçö</option>
                                            <option value="jajan">Jajan üç©</option>
                                            <option value="lain">Lain-lain üõí</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="deskripsiKeluar" class="form-label">Keterangan Tambahan (Opsional)</label>
                                        <textarea class="form-control" id="deskripsiKeluar" rows="2" placeholder="Contoh: Beli kopi dan gorengan..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger w-100 btn-hover-scale">Simpan Uang Keluar</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-danger text-white fw-bold">‚ûñ Riwayat Uang Keluar</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm table-glow mb-0">
                                        <thead class="table-danger">
                                            <tr>
                                                <th>Nominal</th>
                                                <th>Kategori</th>
                                                <th>Keterangan</th> 
                                                <th>Waktu</th>
                                            </tr>
                                        </thead>
                                        <tbody id="riwayatKeluarBody">
                                            <tr><td colspan="4" class="text-center">Belum ada uang keluar.</td></tr> 
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="card card-glow">
                            <div class="card-header bg-info text-white fw-bold">üìä Rekap Rata-rata Keluar Harian per Bulan</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover table-sm table-glow mb-0">
                                        <thead class="table-info">
                                            <tr>
                                                <th>Bulan/Tahun</th>
                                                <th>Rata-rata Harian</th>
                                                <th>Total Keluar</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rekapBulananBody">
                                            <tr><td colspan="3" class="text-center">Belum ada data pengeluaran.</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div id="toastContainer">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    <script>
        // --- 1. SETUP DATA DI LOCALSTORAGE ---
        const STORAGE_KEY = 'manajemenKeuanganData';

        let appData = {
            saldo: 0,
            uangMakan: {
                totalDana: 0,
                terpakai: 0,
            },
            transaksiMasuk: [],
            transaksiKeluar: [],
            cekBalanceHistory: [],
        };

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                appData = JSON.parse(storedData);
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        }

        // --- 2. FUNGSI UTILITY (Format, Notifikasi, Tanggal) ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }
        
        function formatDateTime(isoString) {
            const date = new Date(isoString);
            const d = date.getDate().toString().padStart(2, '0');
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const y = date.getFullYear();
            const h = date.getHours().toString().padStart(2, '0');
            const min = date.getMinutes().toString().padStart(2, '0');
            return `${d}/${m}/${y} ${h}:${min}`;
        }

        function getStartOfDay(date) {
            const newDate = new Date(date);
            newDate.setHours(0, 0, 0, 0);
            return newDate;
        }

        function showCustomToast(message, type = 'success') {
            const bgClass = {
                success: 'bg-success',
                warning: 'bg-warning',
                danger: 'bg-danger',
                info: 'bg-info'
            }[type] || 'bg-primary';

            const textColor = type === 'warning' ? 'text-dark' : 'text-white';
            
            const toastHtml = `
                <div class="toast align-items-center ${bgClass} ${textColor} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body fw-bold">
                            ${message}
                        </div>
                        <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer');
            const newToast = document.createElement('div');
            newToast.innerHTML = toastHtml;
            toastContainer.appendChild(newToast.firstChild);
            
            const toastEl = new bootstrap.Toast(newToast.firstChild, {
                delay: 4000 // Muncul 4 detik
            });
            
            toastEl.show();

            newToast.firstChild.addEventListener('hidden.bs.toast', () => {
                newToast.remove();
            });
        }

        // --- 3. FUNGSI UPDATE TAMPILAN UTAMA ---

        function calculateAverageDailyExpense() {
            const expenses = appData.transaksiKeluar;
            if (expenses.length === 0) return 0;

            const totalExpense = expenses.reduce((sum, t) => sum + t.nominal, 0);

            const dates = expenses.map(t => getStartOfDay(new Date(t.timestamp)).getTime());
            const firstDate = new Date(Math.min(...dates));
            const lastDate = new Date(Math.max(...dates));
            
            const diffTime = Math.abs(lastDate - firstDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            if (diffDays === 0 || isNaN(diffDays)) return totalExpense; 
            
            return Math.round(totalExpense / diffDays);
        }

        // FUNGSI BARU UNTUK QUICK REVIEW PENGELUARAN
        function calculateQuickExpenseReview() {
            const expenses = appData.transaksiKeluar;
            if (expenses.length === 0) {
                return { hariIni: 0, kemarin: 0, mingguIni: 0 };
            }

            const today = getStartOfDay(new Date());
            
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            // Hitung awal minggu (Minggu = 0, Senin = 1, dst. Kita anggap Senin hari pertama)
            const firstDayOfWeek = new Date(today);
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday, etc.
            const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Jika Minggu (0), kurangi 6 hari (ke Senin minggu lalu), jika bukan, kurangi dayOfWeek - 1 (ke Senin minggu ini)
            firstDayOfWeek.setDate(today.getDate() - diff);
            const startOfWeek = getStartOfDay(firstDayOfWeek);


            let totalHariIni = 0;
            let totalKemarin = 0;
            let totalMingguIni = 0;

            expenses.forEach(t => {
                const expenseDate = getStartOfDay(new Date(t.timestamp));
                const time = expenseDate.getTime();

                // Hari Ini
                if (time === today.getTime()) {
                    totalHariIni += t.nominal;
                }

                // Kemarin
                if (time === yesterday.getTime()) {
                    totalKemarin += t.nominal;
                }

                // Minggu Ini (Sejak startOfWeek sampai hari ini)
                if (time >= startOfWeek.getTime() && time <= today.getTime()) {
                    totalMingguIni += t.nominal;
                }
            });

            return {
                hariIni: totalHariIni,
                kemarin: totalKemarin,
                mingguIni: totalMingguIni
            };
        }


        function updateMainDisplays() {
            // Update Saldo dan Rata-rata
            document.getElementById('totalSaldoDisplay').textContent = formatRupiah(appData.saldo);
            const avgDailyExpense = calculateAverageDailyExpense();
            document.getElementById('avgDailyExpenseDisplay').textContent = formatRupiah(avgDailyExpense);
            
            // Panggil Quick Review
            const reviewData = calculateQuickExpenseReview();
            document.getElementById('reviewHariIni').textContent = formatRupiah(reviewData.hariIni);
            document.getElementById('reviewKemarin').textContent = formatRupiah(reviewData.kemarin);
            document.getElementById('reviewMingguIni').textContent = formatRupiah(reviewData.mingguIni);
            
            // Update Dana Makan
            document.getElementById('totalDanaMakan').textContent = formatRupiah(appData.uangMakan.totalDana);
            document.getElementById('terpakaiMakan').textContent = formatRupiah(appData.uangMakan.terpakai);
            document.getElementById('sisaDanaMakan').textContent = formatRupiah(appData.uangMakan.totalDana - appData.uangMakan.terpakai);

            // Update Riwayat Transaksi
            updateRiwayatMasuk();
            updateRiwayatKeluar();

            // Update Rekap Bulanan
            updateRekapBulanan();

            saveData();
        }

        function getMonthIndex(monthName) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return months.indexOf(monthName);
        }
        
        function updateRekapBulanan() {
            const rekapBulanan = {};

            appData.transaksiKeluar.forEach(t => {
                const date = new Date(t.timestamp);
                const monthYearKey = `${date.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`;
                const dateOnly = date.toISOString().slice(0, 10); // YYYY-MM-DD
                
                if (!rekapBulanan[monthYearKey]) {
                    rekapBulanan[monthYearKey] = {
                        totalExpense: 0,
                        uniqueDays: new Set()
                    };
                }
                
                rekapBulanan[monthYearKey].totalExpense += t.nominal;
                rekapBulanan[monthYearKey].uniqueDays.add(dateOnly);
            });

            const rekapBody = document.getElementById('rekapBulananBody');
            rekapBody.innerHTML = '';

            const sortedKeys = Object.keys(rekapBulanan).sort((a, b) => {
                const datePartsA = a.split(' ');
                const datePartsB = b.split(' ');
                const monthA = getMonthIndex(datePartsA[0]);
                const yearA = parseInt(datePartsA[1]);
                const monthB = getMonthIndex(datePartsB[0]);
                const yearB = parseInt(datePartsB[1]);

                if (yearA !== yearB) return yearB - yearA;
                return monthB - monthA;
            });

            if (sortedKeys.length === 0) {
                 rekapBody.innerHTML = '<tr><td colspan="3" class="text-center">Belum ada data pengeluaran.</td></tr>';
                 return;
            }

            sortedKeys.forEach(key => {
                const data = rekapBulanan[key];
                const totalDays = data.uniqueDays.size;
                const avgDaily = Math.round(data.totalExpense / totalDays);

                const row = `
                    <tr>
                        <td>${key}</td>
                        <td class="fw-bold text-danger">${formatRupiah(avgDaily)}</td>
                        <td>${formatRupiah(data.totalExpense)}</td>
                    </tr>
                `;
                rekapBody.innerHTML += row;
            });
        }
        
        // --- 4. FUNGSI RIWAYAT TRANSAKSI ---
        
        function updateRiwayatMasuk() {
            const riwayatBody = document.getElementById('riwayatMasukBody');
            riwayatBody.innerHTML = '';

            if (appData.transaksiMasuk.length === 0) {
                riwayatBody.innerHTML = '<tr><td colspan="2" class="text-center">Belum ada uang masuk.</td></tr>';
                return;
            }

            const sorted = [...appData.transaksiMasuk].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sorted.forEach(t => {
                const row = `
                    <tr>
                        <td class="text-success fw-bold">${formatRupiah(t.nominal)}</td>
                        <td>${formatDateTime(t.timestamp)}</td>
                    </tr>
                `;
                riwayatBody.innerHTML += row;
            });
        }

        function updateRiwayatKeluar() {
            const riwayatBody = document.getElementById('riwayatKeluarBody');
            riwayatBody.innerHTML = '';

            if (appData.transaksiKeluar.length === 0) {
                riwayatBody.innerHTML = '<tr><td colspan="4" class="text-center">Belum ada uang keluar.</td></tr>';
                return;
            }

            const sorted = [...appData.transaksiKeluar].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sorted.forEach(t => {
                const deskripsiText = t.deskripsi ? t.deskripsi : '-';
                
                const row = `
                    <tr>
                        <td class="text-danger fw-bold">${formatRupiah(t.nominal)}</td>
                        <td>${t.kategori.charAt(0).toUpperCase() + t.kategori.slice(1)}</td>
                        <td>${deskripsiText}</td> 
                        <td>${formatDateTime(t.timestamp)}</td>
                    </tr>
                `;
                riwayatBody.innerHTML += row;
            });
        }

        // --- 5. LISTENER: INPUT UANG MASUK ---

        document.getElementById('uangMasukForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nominal = parseInt(document.getElementById('nominalMasuk').value);
            const now = new Date();
            
            if (nominal <= 0 || isNaN(nominal)) {
                showCustomToast('Nominal harus lebih dari 0!', 'danger');
                return;
            }

            appData.saldo += nominal;
            
            const newTransaction = {
                nominal: nominal,
                timestamp: now.toISOString(),
                type: 'masuk'
            };

            appData.transaksiMasuk.push(newTransaction);
            
            updateMainDisplays();
            showCustomToast(`+${formatRupiah(nominal)} masuk! Saldo lo diperbarui.`, 'success');
            document.getElementById('uangMasukForm').reset();
        });

        // --- 6. LISTENER: INPUT UANG KELUAR ---
        document.getElementById('uangKeluarForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nominal = parseInt(document.getElementById('nominalKeluar').value);
            const kategori = document.getElementById('keteranganKeluar').value;
            const deskripsi = document.getElementById('deskripsiKeluar').value.trim(); 
            const now = new Date();

            if (nominal <= 0 || isNaN(nominal) || !kategori) {
                showCustomToast('Nominal harus lebih dari 0 dan kategori wajib diisi!', 'danger');
                return;
            }

            if (appData.saldo < nominal) {
                showCustomToast(`Saldo lo gak cukup (${formatRupiah(appData.saldo)}) untuk pengeluaran ${formatRupiah(nominal)}!`, 'danger');
                return;
            }

            appData.saldo -= nominal;

            const newTransaction = {
                nominal: nominal,
                kategori: kategori,
                deskripsi: deskripsi, 
                timestamp: now.toISOString(),
                type: 'keluar'
            };

            appData.transaksiKeluar.push(newTransaction);

            if (kategori === 'makan') {
                if (appData.uangMakan.totalDana - appData.uangMakan.terpakai < nominal) {
                     showCustomToast(`Dana uang makan lo defisit ${formatRupiah(nominal - (appData.uangMakan.totalDana - appData.uangMakan.terpakai))}. Cek dananya!`, 'warning');
                }
                appData.uangMakan.terpakai += nominal;
                showCustomToast(`-${formatRupiah(nominal)} buat makan! Saldo dan dana makan berkurang.`, 'info');
            } else {
                showCustomToast(`-${formatRupiah(nominal)} buat ${kategori}! Saldo berkurang.`, 'warning');
            }

            updateMainDisplays();
            document.getElementById('uangKeluarForm').reset();
        });

        // --- 7. LISTENER: TABEL UANG MAKAN (Tambah Dana) ---

        document.getElementById('addUangMakanForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const nominal = parseInt(document.getElementById('addUangMakan').value);
            
            if (nominal <= 0 || isNaN(nominal)) {
                showCustomToast('Nominal harus lebih dari 0!', 'danger');
                return;
            }

            appData.uangMakan.totalDana += nominal;

            updateMainDisplays();
            showCustomToast(`+${formatRupiah(nominal)} masuk ke Dana Uang Makan!`, 'success');
            document.getElementById('addUangMakanForm').reset();
        });

        // --- 8. LISTENER: CEK BALANCE ---

        document.getElementById('cekBalanceForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const uangNyata = parseInt(document.getElementById('uangNyata').value);
            const saldoSistem = appData.saldo;

            if (isNaN(uangNyata)) {
                showCustomToast('Isi nominal uang nyata lo dulu!', 'danger');
                return;
            }

            const selisih = saldoSistem - uangNyata;
            const balanceResultDiv = document.getElementById('balanceResult');
            const selisihResultText = document.getElementById('selisihResultText');
            
            document.getElementById('saldoSistemDisplay').textContent = formatRupiah(saldoSistem);
            document.getElementById('uangNyataDisplay').textContent = formatRupiah(uangNyata);

            balanceResultDiv.style.display = 'block';
            
            let message = '';
            let type = '';

            if (selisih === 0) {
                message = 'BALANCE! Saldo Sistem dan Uang Nyata lo Cocok. üëç';
                type = 'success';
                balanceResultDiv.className = 'mt-3 p-3 text-center rounded border border-success';
            } else if (selisih > 0) {
                message = `DEFISIT! Saldo Nyata lo KURANG ${formatRupiah(selisih)}. üò±`;
                type = 'danger';
                balanceResultDiv.className = 'mt-3 p-3 text-center rounded border border-danger';
            } else {
                message = `SURPLUS! Saldo Nyata lo LEBIH ${formatRupiah(Math.abs(selisih))}. üòé`;
                type = 'info';
                balanceResultDiv.className = 'mt-3 p-3 text-center rounded border border-info';
            }

            selisihResultText.innerHTML = `<strong>${message}</strong>`;

            appData.cekBalanceHistory.push({
                saldoSistem: saldoSistem,
                uangNyata: uangNyata,
                selisih: selisih,
                timestamp: new Date().toISOString()
            });
            saveData();
            showCustomToast(`Cek Balance Selesai: ${message}`, type);
        });

        // --- 9. LISTENER: RESET DATA ---
        document.getElementById('resetDataBtn').addEventListener('click', function() {
            if (confirm('Yakin mau reset SEMUA data? Ini akan menghapus semua saldo, transaksi, dan rekap lo!')) {
                // Reset appData ke kondisi awal
                appData = {
                    saldo: 0,
                    uangMakan: {
                        totalDana: 0,
                        terpakai: 0,
                    },
                    transaksiMasuk: [],
                    transaksiKeluar: [],
                    cekBalanceHistory: [],
                };
                
                // Hapus dari localStorage dan inisialisasi ulang tampilan
                localStorage.removeItem(STORAGE_KEY);
                
                // Reset tampilan form cek balance
                document.getElementById('balanceResult').style.display = 'none';
                document.getElementById('cekBalanceForm').reset();
                
                updateMainDisplays();
                showCustomToast('Semua data keuangan lo sudah di-reset!', 'danger');
            }
        });

        // --- 10. INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateMainDisplays();
            showCustomToast('Data dimuat dari LocalStorage.', 'info');
        });
        
    </script>

</body>
</html>